<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" media="(prefers-color-scheme: dark)">
  <title>Jeu de piste du lyc√©e ‚Äî Femmes c√©l√®bres</title>

  <!-- Th√®me modernis√© + adaptations mobile (fonctionnalit√©s inchang√©es) -->
  <style>
    :root{
      --bg:#0b1020; --bg2:#111a33; --card:#0f1426;
      --muted:#97a3ba; --text:#eef3ff;
      --accent:#5ad0ff; --accent2:#8aa4ff; --ring:#94f0ff;
      --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --border:rgba(255,255,255,.10); --glass:rgba(255,255,255,.06);
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    html,body{height:100%} *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      background:
        radial-gradient(1200px 800px at 20% -10%, #1a2347 0%, var(--bg) 60%),
        radial-gradient(900px 700px at 120% 0%, #14224a 0%, transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      min-height:100%;
      overflow-y:overlay;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    @keyframes floatBG { from{background-position:0 0, 0 0, 0 0} to{background-position:20px 10px, -10px 15px, 0 0} }
    @media (prefers-reduced-motion: no-preference){
      body{ animation: floatBG 18s ease-in-out infinite alternate }
    }

    .container{max-width:1040px;margin:0 auto;padding:28px 20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
    h1{font-size:clamp(24px,5vw,40px);margin:0;letter-spacing:.2px;line-height:1.1}
    .badge{
      display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#071019;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      padding:6px 10px;border-radius:999px;font-weight:800;
      box-shadow:0 4px 14px rgba(90,208,255,.35); position:relative; isolation:isolate;
    }
    .badge:after{
      content:""; position:absolute; inset:0; border-radius:999px;
      background:linear-gradient(90deg, rgba(255,255,255,.25), rgba(255,255,255,0));
      mix-blend-mode:overlay; opacity:.5; pointer-events:none;
    }

    .card{
      background:linear-gradient(180deg, var(--glass), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px;
      backdrop-filter:saturate(130%) blur(8px);
    }

    .grid{display:grid; gap:18px}
    @media (min-width:820px){ .grid{ grid-template-columns: 2fr 1fr } }

    label{display:block;font-weight:700;margin:14px 0 6px;letter-spacing:.2px}

    input[type="text"]{
      width:100%;padding:16px 16px;border-radius:14px; min-height:48px;
      border:1px solid var(--border);
      background:rgba(7,12,25,.7);
      color:var(--text); outline:none; transition:.25s ease;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
      -webkit-tap-highlight-color: transparent;
    }
    input::placeholder{color:#8ea0bd}
    input[type="text"]:focus{
      border-color:transparent;
      box-shadow:0 0 0 4px color-mix(in oklab, var(--ring) 40%, transparent),
                 inset 0 0 0 1px rgba(255,255,255,.03);
      background:rgba(7,12,25,.85);
    }

    button{
      appearance:none;border:none;cursor:pointer;font-weight:800;
      padding:14px 18px;border-radius:12px;color:#08111b; min-height:48px;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      box-shadow:0 8px 18px rgba(90,208,255,.35);
      transition:transform .12s ease, box-shadow .2s ease, opacity .2s ease;
      letter-spacing:.2px; -webkit-tap-highlight-color: transparent;
    }
    button:hover{ transform:translateY(-1px); box-shadow:0 12px 26px rgba(90,208,255,.42) }
    button:active{ transform:translateY(0) scale(.98) }
    button.secondary{
      background:rgba(7,12,25,.7); color:var(--text);
      border:1px solid var(--border);
      box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    button.secondary:hover{ filter:brightness(1.04) }
    button.disabled, button:disabled{ opacity:.6; cursor:not-allowed; filter:saturate(.7) }

    .muted{color:var(--muted)}
    .success{color:var(--good)} .error{color:var(--bad)} .warn{color:var(--warn)}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;background:rgba(7,12,25,.7);
      border:1px solid var(--border);font-size:12px;color:var(--muted)
    }

    .progress{
      height:12px;background:rgba(7,12,25,.6);
      border-radius:999px;overflow:hidden;border:1px solid var(--border);
      box-shadow:inset 0 2px 8px rgba(0,0,0,.35);
    }
    .progress>div{
      height:100%;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      width:0%;
      transition:width .35s ease;
    }

    .kbd{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;background:rgba(7,12,25,.7);
      border:1px solid var(--border); border-bottom-width:3px;
      padding:2px 6px;border-radius:6px
    }

    .footer{opacity:.85;font-size:12px;margin-top:28px}
    .center{display:flex;align-items:center;justify-content:center;text-align:center}

    #titre-enigme{font-size:clamp(18px,4.8vw,24px);margin:0}
    #riddle{font-size:clamp(16px,4.4vw,18px);line-height:1.6;margin-top:16px}

    a{color:color-mix(in oklab, var(--accent) 85%, white 15%); text-decoration:none}
    a:hover{text-decoration:underline}

    #next-clue{
      background:linear-gradient(180deg, rgba(34,197,94,.10), rgba(34,197,94,.06));
      border-color:rgba(34,197,94,.35);
    }
    #finish-screen h2{ font-size:clamp(22px,5vw,28px) }
    #chrono-pill, #best-pill{ border-color:rgba(255,255,255,.14) }

    aside figure img{
      width:100%;max-height:260px;object-fit:cover;border-radius:14px;opacity:.92;
      border:1px solid var(--border); box-shadow:0 6px 18px rgba(0,0,0,.3)
    }
    aside figcaption{ color:var(--muted) }

    :focus-visible{ outline:none; box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 50%, transparent) }
    button, input{ touch-action:manipulation }

    /* ======= Optimisations Mobile ======= */
    .play-head{
      position: sticky;
      top: calc(env(safe-area-inset-top, 0) + 8px);
      z-index: 2;
      padding-bottom: 8px;
      margin-bottom: 8px;
      background: linear-gradient(180deg, rgba(15,20,38,.95), rgba(15,20,38,.65));
      backdrop-filter: blur(6px) saturate(120%);
      border-bottom:1px solid rgba(255,255,255,.06);
      border-top-left-radius: 12px; border-top-right-radius: 12px;
    }
    #actionbar{
      position: sticky;
      bottom: calc(env(safe-area-inset-bottom, 0) + 8px);
      z-index: 3;
      display:flex;gap:8px;align-items:center;flex-wrap:nowrap;
      padding:8px;
      margin-top:12px;
      background: linear-gradient(180deg, rgba(11,16,32,.75), rgba(11,16,32,.9));
      backdrop-filter: blur(8px) saturate(140%);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
      transform: translateZ(0);
    }
    #actionbar button{ flex:1; min-width:0 }
    #game-grid{ scroll-margin-top: 8px }

    /* Sidebar plus compact sur mobile */
    #sidebar-card .card, #sidebar-card li.card{ box-shadow:none }
    #sidebar-list li{ padding:10px !important }
    #sidebar-list .pill{ font-size:11px; padding:5px 8px }

    /* Bouton reset discret (lien) dans le pied de page */
    .link-reset{
      background:transparent; border:none; color:var(--muted);
      padding:6px 8px; border-radius:8px; cursor:pointer;
      text-decoration:underline;
    }
    .link-reset:hover{ color:var(--text); background:rgba(255,255,255,.06) }
    .link-reset:focus-visible{ outline:none; box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 45%, transparent) }

    /* Layout & paddings resserr√©s sur petits √©crans */
    @media (max-width:820px){
      .container{ padding:16px 12px }
      .card{ padding:16px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.28) }
      header{ gap:10px; margin-bottom:10px }
      #riddle{ margin-top:12px }
      label{ margin:12px 0 6px }
      .progress{ height:10px }
      .pill{ font-size:11px }
      aside figure img{ max-height:200px }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Jeu de piste <span class="badge">Femmes c√©l√®bres</span></h1>
      <!-- Boutons en-t√™te supprim√©s pour ne pas impacter le titre -->
    </header>

    <p class="muted">Lis l‚Äô√©nigme ‚Üí rends-toi devant la <strong>salle</strong> ‚Üí saisis le <strong>code</strong> affich√©. Si le code correspond bien √† la femme vis√©e, tu passes √† la suite. Le parcours choisit <span id="target-count">7</span> √©nigmes <strong>au hasard</strong> sur une base de 20.</p>

    <div class="grid" id="game-grid">
      <!-- Colonne principale: √©nigme en cours -->
      <section class="card" aria-labelledby="titre-enigme" id="play-section">
        <div class="play-head" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <h2 id="titre-enigme" style="margin:0;font-size:22px">√ânigme <span id="step-num">1</span> / <span id="step-total">?</span></h2>
          <span class="pill" id="theme-label">En qu√™te‚Ä¶</span>
        </div>

        <div class="progress" aria-hidden="true" title="Progression">
          <div id="progressbar"></div>
        </div>

        <p id="riddle"></p>

        <label for="code">Code trouv√© dans la salle</label>
        <input id="code" type="text" placeholder="Ex : KA-204, 7F3X, 1791‚Ä¶" autocomplete="off" />

        <!-- Barre d‚Äôactions collante (aucun changement de logique) -->
        <div id="actionbar">
          <button id="btn-validate">Valider</button>
          <button id="btn-hint" class="secondary disabled" title="Indice disponible apr√®s 5 min">Indice (05:00)</button>
        </div>

        <p id="feedback" class="muted" style="min-height:24px;margin-top:6px"></p>

        <div id="next-clue" class="card" style="display:none;margin-top:12px;background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.35)">
          <strong class="success">Bravo !</strong>
          <p style="margin:6px 0 0" id="next-text">Passe √† l‚Äô√©nigme suivante.</p>
        </div>
      </section>

      <!-- Colonne secondaire: correspondances (sans descriptions) -->
      <aside class="card" id="sidebar-card">
        <h3 style="margin-top:0">Correspondances</h3>
        <div id="sidebar-list" style="margin:10px 0 0"></div>

        <figure style="margin:16px 0 0">
          <img src="plan.png" alt="Plan du lyc√©e (remplacez ce fichier par votre plan)" style="width:100%;max-height:260px;object-fit:cover;border-radius:12px;opacity:.85" onerror="this.style.display='none'">
          <figcaption class="muted" style="margin-top:6px">Astuce : ajoutez un plan <code>plan.png</code>.</figcaption>
        </figure>
      </aside>
    </div>

    <!-- √âcran final -->
    <section id="finish-screen" class="card center" style="display:none;flex-direction:column;gap:8px;min-height:280px">
      <h2 style="margin:0">üéâ Parcours termin√© !</h2>
      <p class="muted" id="finish-detail">Bravo !</p>
      <div class="pill" id="chrono-pill">‚è±Ô∏è Temps : 00:00</div>
      <div class="pill" id="best-pill" style="display:none">üèÅ Record : 00:00</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btn-replay">Rejouer (nouveau tirage)</button>
        <button id="btn-reset2" class="secondary">R√©initialiser</button>
      </div>
    </section>

    <div class="footer muted" style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <span id="progress-info">Progression : 0%</span>
      <!-- bouton reset discret, √©loign√© du titre -->
      <button id="btn-reset" class="link-reset" title="R√©initialiser la progression">‚Ü∫ R√©initialiser</button>
    </div>
  </div>

  <script>
    // ==============================
    // ========= CONFIGURATION ======
    // ==============================

    const SETTINGS = {
      title: "Jeu de piste ‚Äî Femmes c√©l√®bres",
      storageKey: "lycee-piste-femmes-v3",
      roundsTarget: 7,
    };

    // Indice : d√©lai de d√©blocage (5 minutes)
    const HINT_DELAY_MS = 5 * 60 * 1000;
    let hintTimer = null;
    let hintTicker = null;

    const POOL = [
      { name:"Marie Curie", room:"425", code:"RADIO1903",
        riddle:"Premi√®re femme √† recevoir un prix Nobel, elle a d√©couvert le radium et le polonium.",
        hint:"√âtage 4 ‚Äî labo de sciences. Radioactivit√©, deux Prix Nobel (1903/1911)." },

      { name:"Rosalind Franklin", room:"502", code:"ADN1952",
        riddle:"Ses clich√©s aux rayons X ont rendu visible la double h√©lice de l‚ÄôADN.",
        hint:"√âtage 5 ‚Äî SVT/microscopes. ¬´ Photo 51 ¬ª et structure de l‚ÄôADN (1952)." },

      { name:"Ada Lovelace", room:"501", code:"CODE1843",
        riddle:"Au XIX·µâ si√®cle, elle a imagin√© le premier algorithme pour la machine analytique.",
        hint:"√âtage 5 ‚Äî informatique. Algorithme, Babbage, 1843." },

      { name:"Katherine Johnson", room:"320B", code:"LUNE1969",
        riddle:"Math√©maticienne de la NASA, ses calculs ont permis la r√©ussite d‚ÄôApollo.",
        hint:"√âtage 3 ‚Äî maths/physique. Trajectoires, Lune, 1969." },

      { name:"Emmy Noether", room:"321", code:"THEOREME1918",
        riddle:"Son th√©or√®me relie sym√©tries et lois de conservation, fondamental en physique.",
        hint:"√âtage 3 ‚Äî maths. Sym√©tries ‚áí conservations (1918)." },

      { name:"Maria Montessori", room:"202", code:"ECOLE1907",
        riddle:"Pionni√®re d‚Äôune p√©dagogie centr√©e sur l‚Äôautonomie et le mat√©riel sensoriel.",
        hint:"√âtage 2 ‚Äî doc/√©tude. P√©dagogie active, autonomie (1907)." },

      { name:"Simone Veil", room:"203", code:"LOI1975",
        riddle:"Rescap√©e des camps, ministre de la Sant√©, elle fait voter une loi historique.",
        hint:"√âtage 2 ‚Äî EMC/Histoire. Loi de 1975, droits des femmes." },

      { name:"Olympe de Gouges", room:"306", code:"DROITS1791",
        riddle:"Autrice de la D√©claration des droits de la femme et de la citoyenne.",
        hint:"√âtage 3 ‚Äî Histoire (R√©volution). D√©claration, 1791." },

      { name:"Juana In√©s de la Cruz", room:"111", code:"SORJUANA1691",
        riddle:"Religieuse et √©crivaine mexicaine du XVII·µâ si√®cle, d√©fenseuse du savoir des femmes.",
        hint:"√âtage 1 ‚Äî lettres/espagnol. ¬´ Respuesta a Sor Filotea ¬ª (1691)." },

      { name:"Billie Jean King", room:"210A", code:"BATTLE1973",
        riddle:"Championne de tennis et militante, elle remporte la ¬´ Battle of the Sexes ¬ª.",
        hint:"√âtage 2 ‚Äî EPS/sport. Tennis, √©galit√©, 1973." },

      { name:"Fatima Al-Fihriya", room:"102A", code:"UNIVERSITE859",
        riddle:"Bienfaitrice de F√®s au IX·µâ si√®cle, elle fonde un centre d‚Äô√©tude devenu universit√©.",
        hint:"√âtage 1 ‚Äî √©ducation/biblioth√®que. al-Qarawiyyin (~859)." },

      { name:"Dorothy Crawford", room:"420", code:"VIRUS2002",
        riddle:"Virologue et vulgarisatrice, elle raconte comment vivent et se propagent les virus.",
        hint:"√âtage 4 ‚Äî SVT/biologie. Virus, √©pid√©mies, vulgarisation." },

      { name:"√âmilie du Ch√¢telet", room:"504", code:"NEWTON1749",
        riddle:"Savante des Lumi√®res, traductrice et commentatrice des Principia.",
        hint:"√âtage 5 ‚Äî philo/sciences. Newton, Principia (1749)." },

      { name:"Anne Frank", room:"304", code:"JOURNAL1947",
        riddle:"Adolescente juive cach√©e √† Amsterdam, son journal devient un t√©moignage mondial.",
        hint:"√âtage 3 ‚Äî lettres/histoire. Journal (1947), Seconde Guerre mondiale." },

      { name:"Jane Austen", room:"313", code:"PRIDE1813",
        riddle:"Romanci√®re anglaise au regard fin sur la soci√©t√© de son temps.",
        hint:"√âtage 3 ‚Äî litt√©rature anglaise. ¬´ Pride and Prejudice ¬ª (1813)." },

      { name:"Toni Morrison", room:"Amphith√©√¢tre", code:"NOBEL1993",
        riddle:"Premi√®re autrice afro-am√©ricaine √† recevoir le Prix Nobel de litt√©rature.",
        hint:"Salle sp√©ciale ‚Äî grand amphith√©√¢tre (pas de num√©ro). ¬´ Beloved ¬ª, Nobel 1993." },

      { name:"Pauline L√©on", room:"308", code:"CLUB1793",
        riddle:"R√©volutionnaire, elle fonde le club des citoyennes r√©publicaines r√©volutionnaires.",
        hint:"√âtage 3 ‚Äî Histoire (R√©volution). Clubs f√©minins, 1793." },

      { name:"Charlotte Delbo", room:"109", code:"RESIST1946",
        riddle:"R√©sistante d√©port√©e, elle t√©moigne du camp dans ses ≈ìuvres.",
        hint:"√âtage 1 ‚Äî th√©√¢tre/lettres. T√©moignage, m√©moire." },

      { name:"George Sand", room:"101A", code:"INDIANA1832",
        riddle:"Plume libre du XIX·µâ si√®cle ; ¬´ Indiana ¬ª marque ses d√©buts litt√©raires.",
        hint:"√âtage 1 ‚Äî fran√ßais. Pseudonyme masculin, 1832 (¬´ Indiana ¬ª)." },

      { name:"Teresa Perales", room:"103", code:"NATATION2000",
        riddle:"Nageuse espagnole, multi-m√©daill√©e paralympique sur plusieurs Jeux.",
        hint:"√âtage 1 ‚Äî sport. Natation paralympique, depuis Sydney 2000." }
    ];

    // ==============================
    // ======== LOGIQUE JEU =========
    // ==============================

    const ui = {
      stepNum: document.getElementById('step-num'),
      stepTotal: document.getElementById('step-total'),
      themeLabel: document.getElementById('theme-label'),
      riddle: document.getElementById('riddle'),
      code: document.getElementById('code'),
      feedback: document.getElementById('feedback'),
      nextClue: document.getElementById('next-clue'),
      nextText: document.getElementById('next-text'),
      progressbar: document.getElementById('progressbar'),
      progressInfo: document.getElementById('progress-info'),
      btnValidate: document.getElementById('btn-validate'),
      btnHint: document.getElementById('btn-hint'),
      btnReset: document.getElementById('btn-reset'),
      btnReplay: document.getElementById('btn-replay'),
      btnReset2: document.getElementById('btn-reset2'),
    };

    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

    function normCode(str){
      return (str||"")
        .toString()
        .trim()
        .toUpperCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu,'')
        .replace(/[^A-Z0-9]/g,'');
    }

    function loadState(){
      try{ return JSON.parse(localStorage.getItem(SETTINGS.storageKey)) || null; }
      catch(e){ return null; }
    }
    function saveState(s){ localStorage.setItem(SETTINGS.storageKey, JSON.stringify(s)); }

    function shuffleInPlace(arr){
      for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
      return arr;
    }

    function createRun(){
      const target = clamp(SETTINGS.roundsTarget, 1, POOL.length);
      const indices = [...Array(POOL.length).keys()];
      shuffleInPlace(indices);
      const seq = indices.slice(0, target);
      return { seq, i:0, startedAt:null, stepStartedAt:null };
    }

    let state = loadState() || createRun();

    function msToClock(ms){
      const t = Math.max(0, Math.floor(ms/1000));
      const h = Math.floor(t/3600); const m = Math.floor((t%3600)/60); const s = t%60;
      const pad = n=>String(n).padStart(2,'0');
      return h>0 ? `${h}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
    }

    function setProgress(i){
      const total = state.seq.length;
      const ratio = clamp(i/total, 0, 1);
      ui.progressbar.style.width = (ratio*100)+"%";
      ui.progressInfo.textContent = `Progression : ${Math.round(ratio*100)}%`;
      ui.stepTotal.textContent = total;
      ui.stepNum.textContent = clamp(i+1,1,total);
    }

    function showFinish(){
      const finishedAt = Date.now();
      const startedAt = state.startedAt || finishedAt;
      const elapsed = finishedAt - startedAt;
      const keyBest = SETTINGS.storageKey + ':best';
      const prev = Number(localStorage.getItem(keyBest) || 0);
      if(prev===0 || elapsed < prev){ localStorage.setItem(keyBest, String(elapsed)); }
      const best = Number(localStorage.getItem(keyBest) || elapsed);

      ui.chronoPill.textContent = '‚è±Ô∏è Temps : ' + msToClock(elapsed);
      if(best){ document.getElementById('best-pill').style.display = 'inline-block'; document.getElementById('best-pill').textContent = 'üèÅ Record : ' + msToClock(best); }
      document.getElementById('finish-detail').textContent = `Tu as r√©solu ${state.seq.length} √©nigmes, Bravo !`;

      ui.gameGrid.style.display = 'none';
      document.getElementById('finish-screen').style.display = 'flex';
    }

    // ====== Gestion Indice : verrou + compte √† rebours ======
    function setHintButtonLabel(remainingMs){
      if(remainingMs <= 0){
        ui.btnHint.textContent = 'Indice';
        ui.btnHint.title = 'Afficher un indice (d√©bloqu√©)';
      } else {
        const m = Math.floor(remainingMs/60000);
        const s = Math.floor((remainingMs%60000)/1000);
        const pad = (n)=>String(n).padStart(2,'0');
        ui.btnHint.textContent = `Indice (${pad(m)}:${pad(s)})`;
        ui.btnHint.title = `Indice disponible dans ${m} min ${pad(s)} s`;
      }
    }
    function enableHint(){
      if(hintTimer){ clearTimeout(hintTimer); hintTimer = null; }
      if(hintTicker){ clearInterval(hintTicker); hintTicker = null; }
      ui.btnHint.disabled = false;
      ui.btnHint.classList.remove('disabled');
      setHintButtonLabel(0);
    }
    function disableHint(remainingMs){
      ui.btnHint.disabled = true;
      ui.btnHint.classList.add('disabled');
      setHintButtonLabel(remainingMs);
    }
    function setupHintLock(){
      if(hintTimer){ clearTimeout(hintTimer); hintTimer = null; }
      if(hintTicker){ clearInterval(hintTicker); hintTicker = null; }

      const started = state.stepStartedAt || Date.now();
      const elapsed = Date.now() - started;
      const remaining = HINT_DELAY_MS - elapsed;

      if(remaining <= 0){
        enableHint();
        return;
      }
      disableHint(remaining);
      hintTimer = setTimeout(()=>{ enableHint(); }, remaining);

      let last = remaining;
      hintTicker = setInterval(()=>{
        const now = Date.now();
        const rem = Math.max(0, HINT_DELAY_MS - (now - started));
        if(rem !== last){
          disableHint(rem);
          last = rem;
        }
        if(rem <= 0){
          enableHint();
        }
      }, 250);
    }

    // ====== Sidebar : juste Salle ‚Üí Personnalit√© ======
    function renderSidebarList(){
      const box = document.getElementById('sidebar-list');
      if(!box) return;
      const items = [...POOL].sort((a,b)=>String(a.room).localeCompare(String(b.room),'fr',{numeric:true,sensitivity:'base'}));
      const html = [
        '<ul style="list-style:none;margin:0;padding:0;display:grid;gap:10px">',
        ...items.map(item => `
          <li class="card" style="padding:12px;border-radius:12px;background:rgba(7,12,25,.55)">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
              <span class="pill">Salle ${item.room}</span>
              <strong>${item.name}</strong>
            </div>
          </li>
        `),
        '</ul>'
      ].join('');
      box.innerHTML = html;
    }

    function render(){
      document.title = SETTINGS.title;
      document.getElementById('target-count').textContent = SETTINGS.roundsTarget;

      const total = state.seq.length;
      if(state.i >= total){
        setProgress(total);
        showFinish();
        return;
      }

      if(state.i === 0 && !state.startedAt){
        state.startedAt = Date.now();
      }

      const current = POOL[state.seq[state.i]];
      state.stepStartedAt = Date.now();
      saveState(state);

      ui.themeLabel.textContent = 'En qu√™te‚Ä¶';
      ui.riddle.textContent = current.riddle || `Trouve la salle associ√©e √† ${current.name} puis saisis le code.`;
      ui.code.value = '';
      ui.code.disabled = false; ui.btnValidate.disabled = false;

      disableHint(HINT_DELAY_MS);
      setupHintLock();

      ui.feedback.textContent = '';
      ui.feedback.className = 'muted';
      ui.nextClue.style.display = 'none';
      setProgress(state.i);
      ui.code.focus();
    }

    function tryValidate(){
      const total = state.seq.length;
      if(state.i >= total) return;
      const current = POOL[state.seq[state.i]];
      const val = normCode(ui.code.value);
      const ok = val && val === normCode(current.code);

      if(ok){
        ui.feedback.textContent = `Code valide ! (${current.room})`;
        ui.feedback.className = 'success';
        ui.nextClue.style.display = 'block';
        state.i += 1; saveState(state); setProgress(state.i);
        setTimeout(()=>{ render(); }, 600);
      } else {
        ui.feedback.textContent = 'Code incorrect‚Ä¶ v√©rifie bien ce qui est affich√© dans la salle.';
        ui.feedback.className = 'error';
      }
    }

    ui.btnValidate.addEventListener('click', tryValidate);
    ui.code.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ tryValidate(); }});

    ui.btnHint.addEventListener('click', ()=>{
      const total = state.seq.length; if(state.i >= total) return;
      if(ui.btnHint.disabled){
        ui.feedback.textContent = "Patience‚Ä¶ l‚Äôindice sera disponible apr√®s 5 minutes.";
        ui.feedback.className = 'warn';
        return;
      }
      const current = POOL[state.seq[state.i]];
      ui.feedback.textContent = current.hint || 'Pas d\'indice pour cette √©nigme.';
      ui.feedback.className = 'warn';
    });

    function resetAndNewRun(){
      if(hintTimer){ clearTimeout(hintTimer); hintTimer = null; }
      if(hintTicker){ clearInterval(hintTicker); hintTicker = null; }

      state = createRun();
      saveState(state);
      document.getElementById('finish-screen').style.display='none';
      document.getElementById('game-grid').style.display='grid';
      render();
    }

    // Reset (lien discret en pied de page) + boutons √©cran final
    ui.btnReset.addEventListener('click', ()=>{ if(confirm('R√©initialiser la progression du jeu ?')) resetAndNewRun(); });
    ui.btnReplay.addEventListener('click', ()=>{ resetAndNewRun(); });
    ui.btnReset2.addEventListener('click', ()=>{ resetAndNewRun(); });

    // Mode test : Alt + N pour avancer
    window.addEventListener('keydown', (e)=>{ if(e.altKey && (e.key==='n' || e.key==='N')){ state.i = clamp(state.i+1, 0, state.seq.length); saveState(state); render(); }});

    // Initialisations
    renderSidebarList();
    render();
  </script>
</body>
</html>
