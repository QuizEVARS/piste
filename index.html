<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1020" media="(prefers-color-scheme: dark)">
  <title>Jeu de piste du lycée — Femmes célèbres</title>

  <style>
    :root{
      --bg:#0b1020; --bg2:#111a33; --card:#0f1426;
      --muted:#97a3ba; --text:#eef3ff;
      --accent:#5ad0ff; --accent2:#8aa4ff; --ring:#94f0ff;
      --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
      --border:rgba(255,255,255,.10); --glass:rgba(255,255,255,.06);
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
    }
    html,body{height:100%} *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans";
      background:
        radial-gradient(1200px 800px at 20% -10%, #1a2347 0%, var(--bg) 60%),
        radial-gradient(900px 700px at 120% 0%, #14224a 0%, transparent 60%),
        linear-gradient(180deg, var(--bg2), var(--bg));
      min-height:100%;
      overflow-y:overlay;
      padding-bottom: env(safe-area-inset-bottom, 0);
    }
    @keyframes floatBG { from{background-position:0 0, 0 0, 0 0} to{background-position:20px 10px, -10px 15px, 0 0} }
    @media (prefers-reduced-motion: no-preference){
      body{ animation: floatBG 18s ease-in-out infinite alternate }
    }

    .container{max-width:1040px;margin:0 auto;padding:28px 20px}
    header{
      display:flex; flex-direction:column; align-items:center; text-align:center;
      gap:10px; margin-bottom:24px; padding:16px 0;
    }
    h1{
      font-size:clamp(28px,6vw,48px); margin:0; letter-spacing:.3px; line-height:1.1; font-weight:800;
      background:linear-gradient(135deg, var(--accent), var(--accent2), #fff);
      background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      text-shadow:0 0 30px rgba(90,208,255,.3);
    }
    /* Remplacer l'ancien bloc .badge par ceci */
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  font-size:clamp(14px, 2.2vw, 18px); /* un peu plus grand */
  padding:10px 20px;                  /* plus de marge interne */
  border-radius:999px;
  font-weight:800;
  color:#071019;
  background:linear-gradient(135deg, var(--accent), var(--accent2));
  border:2px solid rgba(255,255,255,.22);                  /* contour plus marqué */
  box-shadow:
    0 8px 24px rgba(90,208,255,.45),                       /* ombre plus large */
    0 0 0 4px rgba(90,208,255,.12);                        /* léger halo autour */
}


    .game-description {
      text-align:center; max-width:600px; margin:0 auto 32px; padding:20px;
      background:rgba(255,255,255,.03); border:1px solid var(--border);
      border-radius:16px; backdrop-filter:blur(8px); line-height:1.6;
    }
    .game-description strong { color:var(--accent); font-weight:600; }

    .card{
      background:linear-gradient(180deg, var(--glass), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:24px;
      backdrop-filter:saturate(130%) blur(10px);
      position:relative; overflow:hidden;
    }
    .card::before {
      content:''; position:absolute; top:0; left:0; right:0; height:1px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.2), transparent); opacity:.8;
    }

    .grid{display:grid; gap:20px}
    @media (min-width:820px){ .grid{ grid-template-columns: 2fr 1fr } }

    .play-head{
      position: sticky; top: calc(env(safe-area-inset-top, 0) + 8px); z-index: 2;
      padding:16px 0; margin:-8px -8px 16px;
      background: linear-gradient(180deg, rgba(15,20,38,.95), rgba(15,20,38,.65));
      backdrop-filter: blur(8px) saturate(120%);
      border-bottom:1px solid rgba(255,255,255,.08);
      border-radius: 12px; text-align:center;
    }
    #titre-enigme{
      margin:0; font-size:clamp(20px,5vw,28px); font-weight:700;
      background:linear-gradient(135deg, var(--text), var(--accent2));
      background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:8px;
    }
    .theme-pill{
      display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--muted);
      background:rgba(7,12,25,.6); padding:6px 12px; border-radius:999px; border:1px solid var(--border);
    }
    /* cache la pastille si vide */
    .theme-pill:empty{ display:none; }

    label{
      display:block; font-weight:700; margin:20px 0 8px; letter-spacing:.2px;
      text-align:center; font-size:16px; color:var(--accent2);
    }
    .input-container{ position:relative; margin:16px 0; }
    input[type="text"]{
      width:100%; padding:18px 20px; border-radius:16px; min-height:56px;
      border:2px solid var(--border); background:rgba(7,12,25,.8); color:var(--text);
      outline:none; transition:all .3s ease; box-shadow:inset 0 2px 8px rgba(0,0,0,.2);
      -webkit-tap-highlight-color: transparent; text-align:center; font-size:16px; font-weight:500; letter-spacing:.5px;
    }
    input::placeholder{ color:#8ea0bd; text-align:center; }
    input[type="text"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 6px color-mix(in oklab, var(--ring) 30%, transparent), inset 0 2px 12px rgba(0,0,0,.3);
      background:rgba(7,12,25,.9); transform:translateY(-1px);
    }

    button{
      appearance:none; border:none; cursor:pointer; font-weight:800;
      padding:16px 24px; border-radius:14px; color:#08111b; min-height:52px;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 10px 25px rgba(90,208,255,.4);
      transition:all .2s ease; letter-spacing:.3px; -webkit-tap-highlight-color: transparent; font-size:15px;
      position:relative; overflow:hidden;
    }
    button::before{
      content:''; position:absolute; top:0; left:-100%; right:100%; bottom:0;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.3), transparent); transition:all .6s ease;
    }
    button:hover{ transform:translateY(-2px); box-shadow:0 15px 35px rgba(90,208,255,.5) }
    button:hover::before{ left:100%; right:-100% }
    button:active{ transform:translateY(0) scale(.97) }
    button.secondary{
      background:rgba(7,12,25,.8); color:var(--text); border:2px solid var(--border);
      box-shadow:0 8px 20px rgba(0,0,0,.3);
    }
    button.disabled, button:disabled{ opacity:.5; cursor:not-allowed; transform:none !important; box-shadow:0 4px 10px rgba(0,0,0,.2) !important; }

    .muted{color:var(--muted)} .success{color:var(--good)} .error{color:var(--bad)} .warn{color:var(--warn)}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:999px; background:rgba(7,12,25,.7);
      border:1px solid var(--border); font-size:12px; color:var(--muted); font-weight:500;
    }

    .progress{
      height:8px; background:rgba(7,12,25,.8); border-radius:999px; overflow:hidden;
      border:1px solid var(--border); box-shadow:inset 0 2px 8px rgba(0,0,0,.4); margin:16px 0; position:relative;
    }
    .progress>div{
      height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2), var(--accent)); background-size:200% 100%;
      width:0%; transition:width .5s ease; border-radius:999px; animation:shimmer 2s infinite;
    }
    @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }

    #riddle{
      font-size:clamp(16px,4.4vw,18px); line-height:1.7; margin:24px 0; text-align:center;
      padding:20px; background:rgba(255,255,255,.02); border-radius:14px; border:1px solid rgba(255,255,255,.05); font-style:italic; position:relative;
    }
/* Désactive le guillemet décoratif dans l'encadré de l'énigme */
#riddle::before {
  content: none !important;
}

    #feedback{ text-align:center; margin:16px 0; padding:12px; border-radius:10px; font-weight:500; min-height:20px; }

    #finish-screen{ text-align:center; padding:40px 24px }
    #finish-screen h2{
      font-size:clamp(24px,6vw,36px); margin:0 0 16px;
      background:linear-gradient(135deg, var(--good), var(--accent)); background-clip:text; -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }

    #actionbar{
      position: sticky; bottom: calc(env(safe-area-inset-bottom, 0) + 12px); z-index: 3;
      display:flex; gap:12px; align-items:center; flex-wrap:nowrap;
      padding:12px; margin-top:24px;
      background: linear-gradient(180deg, rgba(11,16,32,.85), rgba(11,16,32,.95));
      backdrop-filter: blur(12px) saturate(150%);
      border:1px solid rgba(255,255,255,.1); border-radius:16px; box-shadow:0 12px 32px rgba(0,0,0,.4);
      transform: translateZ(0);
    }
    #actionbar button{ flex:1; min-width:0 }

    #sidebar-card h3{ text-align:center; margin:0 0 20px; font-size:20px; color:var(--accent2) }

    #sidebar-card .card, #sidebar-card li.card{ box-shadow:none }
    #sidebar-list li{ padding:12px !important }
    #sidebar-list .pill{ font-size:11px; padding:6px 10px }

    aside figure img{
      width:100%;max-height:260px;object-fit:cover;border-radius:14px;opacity:.92;
      border:1px solid var(--border); box-shadow:0 8px 20px rgba(0,0,0,.4)
    }

    .footer{ opacity:.85; font-size:12px; margin-top:32px; text-align:center; display:flex; flex-direction:column; align-items:center; gap:8px }

    :focus-visible{ outline:none; box-shadow:0 0 0 4px color-mix(in oklab, var(--ring) 40%, transparent) !important; }
    button, input{ touch-action:manipulation }

    @media (max-width:820px){
      .container{ padding:16px 12px }
      .card{ padding:20px; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,.3) }
      header{ gap:12px; margin-bottom:20px; padding:16px 0 }
      .game-description{ margin-bottom:24px; padding:16px }
      #riddle{ margin:20px 0; padding:16px }
      label{ margin:16px 0 8px }
      .progress{ height:6px; margin:12px 0 }
      .pill{ font-size:11px; padding:6px 10px }
      aside figure img{ max-height:200px }
      #actionbar{ bottom: calc(env(safe-area-inset-bottom, 0) + 8px); gap:8px; padding:10px }
      .footer{ margin-top:24px }
    }

    .card{ transition:transform .2s ease, box-shadow .2s ease; animation:fadeInUp .6s ease; }
    @media (hover: hover){ .card:hover{ transform:translateY(-2px); box-shadow:0 15px 40px rgba(0,0,0,.4) } }
    @keyframes fadeInUp { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Jeu de piste</h1>
      <span class="badge">Femmes célèbres</span>
    </header>

    <div class="game-description">
      <p>Lis l'<strong>énigme</strong> et devine de quelle <strong>femme célèbre</strong> il s'agit. → Rends-toi devant sa <strong>salle</strong> (correspondances données en dessous). → Saisis le <strong>code</strong> affiché. Si le code correspond bien à la femme visée, tu passes à la suite. Le parcours choisit <span id="target-count">7</span> énigmes <strong>au hasard</strong> sur une base de 20.</p>
    </div>

    <div class="grid" id="game-grid">
      <section class="card" aria-labelledby="titre-enigme" id="play-section">
        <div class="play-head">
          <h2 id="titre-enigme">Énigme <span id="step-num">1</span> / <span id="step-total">?</span></h2>
          <span class="theme-pill" id="theme-label"></span>
        </div>

        <div class="progress" aria-hidden="true" title="Progression">
          <div id="progressbar"></div>
        </div>

        <p id="riddle"></p>

        <label for="code">Code trouvé devant la salle</label>
        <div class="input-container">
          <input id="code" type="text" placeholder="Ex : KA-204, 7F3X, 1791…" autocomplete="off" />
        </div>

        <div id="actionbar">
          <button id="btn-validate">✓ Valider</button>
          <button id="btn-hint" class="secondary disabled" title="Indice disponible après 5 min">💡 Indice (05:00)</button>
        </div>

        <p id="feedback" class="muted"></p>

        <div id="next-clue" class="card" style="display:none">
          <strong class="success">🎉 Bravo !</strong>
          <p style="margin:8px 0 0" id="next-text">Passe à l'énigme suivante.</p>
        </div>
      </section>

      <aside class="card" id="sidebar-card">
        <h3>Correspondances</h3>
        <div id="sidebar-list" style="margin:16px 0 0"></div>

        <figure style="margin:20px 0 0">
          <img src="plan.png" alt="Plan du lycée" onerror="this.style.display='none'">
          <!-- figcaption supprimé comme demandé -->
        </figure>
      </aside>
    </div>

    <section id="finish-screen" class="card center" style="display:none;flex-direction:column;gap:12px;min-height:300px">
      <h2>🎉 Parcours terminé !</h2>
      <p class="muted" id="finish-detail">Bravo !</p>
      <div class="pill" id="chrono-pill">⏱️ Temps : 00:00</div>
      <div class="pill" id="best-pill" style="display:none">🏆 Record : 00:00</div>
      <div style="display:flex;gap:12px;margin-top:16px;flex-wrap:wrap;justify-content:center">
        <button id="btn-replay">🔄 Rejouer</button>
        <button id="btn-reset2" class="secondary">🗑️ Réinitialiser</button>
      </div>
    </section>

    <div class="footer">
      <span id="progress-info">Progression : 0%</span>
      <button id="btn-reset" class="link-reset" title="Réinitialiser la progression">↺ Réinitialiser</button>
    </div>
  </div>

  <script>
    const SETTINGS = { title: "Jeu de piste — Femmes célèbres", storageKey: "lycee-piste-femmes-v3", roundsTarget: 7 };
    const HINT_DELAY_MS = 5 * 60 * 1000;
    let hintTimer = null, hintTicker = null;

    const POOL = [
      { name:"Marie Curie", room:"425", code:"RADIO1903",
        riddle:"Première femme à recevoir un prix Nobel, elle a découvert le radium et le polonium.",
        hint:"Étage 4 — labo de sciences. Radioactivité, deux Prix Nobel (1903/1911)." },
      { name:"Rosalind Franklin", room:"502", code:"ADN1952",
        riddle:"Ses clichés aux rayons X ont rendu visible la double hélice de l'ADN.",
        hint:"Étage 5 — SVT/microscopes. « Photo 51 » et structure de l'ADN (1952)." },
      { name:"Ada Lovelace", room:"501", code:"CODE1843",
        riddle:"Au XIXᵉ siècle, elle a imaginé le premier algorithme pour la machine analytique.",
        hint:"Étage 5 — informatique. Algorithme, Babbage, 1843." },
      { name:"Katherine Johnson", room:"320B", code:"LUNE1969",
        riddle:"Mathématicienne de la NASA, ses calculs ont permis la réussite d'Apollo.",
        hint:"Étage 3 — maths/physique. Trajectoires, Lune, 1969." },
      { name:"Emmy Noether", room:"321", code:"THEOREME1918",
        riddle:"Son théorème relie symétries et lois de conservation, fondamental en physique.",
        hint:"Étage 3 — maths. Symétries ⇒ conservations (1918)." },
      { name:"Maria Montessori", room:"202", code:"ECOLE1907",
        riddle:"Pionnière d'une pédagogie centrée sur l'autonomie et le matériel sensoriel.",
        hint:"Étage 2 — doc/étude. Pédagogie active, autonomie (1907)." },
      { name:"Simone Veil", room:"203", code:"LOI1975",
        riddle:"Rescapée des camps, ministre de la Santé, elle fait voter une loi historique.",
        hint:"Étage 2 — EMC/Histoire. Loi de 1975, droits des femmes." },
      { name:"Olympe de Gouges", room:"306", code:"DROITS1791",
        riddle:"Autrice de la Déclaration des droits de la femme et de la citoyenne.",
        hint:"Étage 3 — Histoire (Révolution). Déclaration, 1791." },
      { name:"Juana Inés de la Cruz", room:"111", code:"SORJUANA1691",
        riddle:"Religieuse et écrivaine mexicaine du XVIIᵉ siècle, défenseuse du savoir des femmes.",
        hint:"Étage 1 — lettres/espagnol. « Respuesta a Sor Filotea » (1691)." },
      { name:"Billie Jean King", room:"210A", code:"BATTLE1973",
        riddle:"Championne de tennis et militante, elle remporte la « Battle of the Sexes ».",
        hint:"Étage 2 — EPS/sport. Tennis, égalité, 1973." },
      { name:"Fatima Al-Fihriya", room:"102A", code:"UNIVERSITE859",
        riddle:"Bienfaitrice de Fès au IXᵉ siècle, elle fonde un centre d'étude devenu université.",
        hint:"Étage 1 — éducation/bibliothèque. al-Qarawiyyin (~859)." },
      { name:"Dorothy Crawford", room:"420", code:"VIRUS2002",
        riddle:"Virologue et vulgarisatrice, elle raconte comment vivent et se propagent les virus.",
        hint:"Étage 4 — SVT/biologie. Virus, épidémies, vulgarisation." },
      { name:"Émilie du Châtelet", room:"504", code:"NEWTON1749",
        riddle:"Savante des Lumières, traductrice et commentatrice des Principia.",
        hint:"Étage 5 — philo/sciences. Newton, Principia (1749)." },
      { name:"Anne Frank", room:"304", code:"JOURNAL1947",
        riddle:"Adolescente juive cachée à Amsterdam, son journal devient un témoignage mondial.",
        hint:"Étage 3 — lettres/histoire. Journal (1947), Seconde Guerre mondiale." },
      { name:"Jane Austen", room:"313", code:"PRIDE1813",
        riddle:"Romancière anglaise au regard fin sur la société de son temps.",
        hint:"Étage 3 — littérature anglaise. « Pride and Prejudice » (1813)." },
      { name:"Toni Morrison", room:"Amphithéâtre", code:"NOBEL1993",
        riddle:"Première autrice afro-américaine à recevoir le Prix Nobel de littérature.",
        hint:"Salle spéciale — grand amphithéâtre (pas de numéro). « Beloved », Nobel 1993." },
      { name:"Pauline Léon", room:"308", code:"CLUB1793",
        riddle:"Révolutionnaire, elle fonde le club des citoyennes républicaines révolutionnaires.",
        hint:"Étage 3 — Histoire (Révolution). Clubs féminins, 1793." },
      { name:"Charlotte Delbo", room:"109", code:"RESIST1946",
        riddle:"Résistante déportée, elle témoigne du camp dans ses œuvres.",
        hint:"Étage 1 — théâtre/lettres. Témoignage, mémoire." },
      { name:"George Sand", room:"101A", code:"INDIANA1832",
        riddle:"Plume libre du XIXᵉ siècle ; « Indiana » marque ses débuts littéraires.",
        hint:"Étage 1 — français. Pseudonyme masculin, 1832 (« Indiana »)." },
      { name:"Teresa Perales", room:"103", code:"NATATION2000",
        riddle:"Nageuse espagnole, multi-médaillée paralympique sur plusieurs Jeux.",
        hint:"Étage 1 — sport. Natation paralympique, depuis Sydney 2000." }
    ];

    const ui = {
      stepNum: document.getElementById('step-num'),
      stepTotal: document.getElementById('step-total'),
      themeLabel: document.getElementById('theme-label'),
      riddle: document.getElementById('riddle'),
      code: document.getElementById('code'),
      feedback: document.getElementById('feedback'),
      nextClue: document.getElementById('next-clue'),
      nextText: document.getElementById('next-text'),
      progressbar: document.getElementById('progressbar'),
      progressInfo: document.getElementById('progress-info'),
      btnValidate: document.getElementById('btn-validate'),
      btnHint: document.getElementById('btn-hint'),
      btnReset: document.getElementById('btn-reset'),
      btnReplay: document.getElementById('btn-replay'),
      btnReset2: document.getElementById('btn-reset2'),
      chronoPill: document.getElementById('chrono-pill'),
      gameGrid: document.getElementById('game-grid'),
    };

    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const normCode = str => (str||"").toString().trim().toUpperCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^A-Z0-9]/g,'');

    function loadState(){ try{ return JSON.parse(localStorage.getItem(SETTINGS.storageKey)) || null; } catch(e){ return null; } }
    function saveState(s){ localStorage.setItem(SETTINGS.storageKey, JSON.stringify(s)); }
    function shuffleInPlace(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
    function createRun(){ const target = clamp(SETTINGS.roundsTarget, 1, POOL.length); const indices = [...Array(POOL.length).keys()]; shuffleInPlace(indices); const seq = indices.slice(0, target); return { seq, i:0, startedAt:null, stepStartedAt:null }; }
    let state = loadState() || createRun();

    function msToClock(ms){ const t = Math.max(0, Math.floor(ms/1000)); const h = Math.floor(t/3600), m = Math.floor((t%3600)/60), s = t%60; const pad=n=>String(n).padStart(2,'0'); return h>0?`${h}:${pad(m)}:${pad(s)}`:`${pad(m)}:${pad(s)}`; }
    function setProgress(i){ const total = state.seq.length, ratio = clamp(i/total,0,1); ui.progressbar.style.width = (ratio*100)+"%"; ui.progressInfo.textContent = `Progression : ${Math.round(ratio*100)}%`; document.getElementById('step-total').textContent = total; document.getElementById('step-num').textContent = clamp(i+1,1,total); }

    function showFinish(){
      const finishedAt = Date.now(), startedAt = state.startedAt || finishedAt, elapsed = finishedAt - startedAt;
      const keyBest = SETTINGS.storageKey + ':best', prev = Number(localStorage.getItem(keyBest) || 0);
      if(prev===0 || elapsed < prev){ localStorage.setItem(keyBest, String(elapsed)); }
      const best = Number(localStorage.getItem(keyBest) || elapsed);
      ui.chronoPill.textContent = '⏱️ Temps : ' + msToClock(elapsed);
      if(best){ document.getElementById('best-pill').style.display = 'inline-block'; document.getElementById('best-pill').textContent = '🏆 Record : ' + msToClock(best); }
      document.getElementById('finish-detail').textContent = `Tu as résolu ${state.seq.length} énigmes, Bravo !`;
      ui.gameGrid.style.display = 'none'; document.getElementById('finish-screen').style.display = 'flex';
    }

    function setHintButtonLabel(remainingMs){
      if(remainingMs <= 0){ ui.btnHint.textContent = '💡 Indice'; ui.btnHint.title = 'Afficher un indice (débloqué)'; }
      else { const m=Math.floor(remainingMs/60000), s=Math.floor((remainingMs%60000)/1000), pad=n=>String(n).padStart(2,'0'); ui.btnHint.textContent = `💡 Indice (${pad(m)}:${pad(s)})`; ui.btnHint.title = `Indice disponible dans ${m} min ${pad(s)} s`; }
    }
    function enableHint(){ if(hintTimer){clearTimeout(hintTimer);} if(hintTicker){clearInterval(hintTicker);} ui.btnHint.disabled=false; ui.btnHint.classList.remove('disabled'); setHintButtonLabel(0); }
    function disableHint(ms){ ui.btnHint.disabled=true; ui.btnHint.classList.add('disabled'); setHintButtonLabel(ms); }
    function setupHintLock(){
      if(hintTimer){ clearTimeout(hintTimer); } if(hintTicker){ clearInterval(hintTicker); }
      const started = state.stepStartedAt || Date.now(), elapsed = Date.now()-started, remaining = HINT_DELAY_MS - elapsed;
      if(remaining <= 0){ enableHint(); return; }
      disableHint(remaining); hintTimer = setTimeout(()=>enableHint(), remaining);
      let last = remaining;
      hintTicker = setInterval(()=>{ const rem = Math.max(0, HINT_DELAY_MS - (Date.now()-started)); if(rem !== last){ disableHint(rem); last = rem; } if(rem <= 0){ enableHint(); } }, 250);
    }

    function renderSidebarList(){
      const box = document.getElementById('sidebar-list'); if(!box) return;
      const items = [...POOL].sort((a,b)=>String(a.room).localeCompare(String(b.room),'fr',{numeric:true,sensitivity:'base'}));
      const html = [
        '<ul style="list-style:none;margin:0;padding:0;display:grid;gap:12px">',
        ...items.map(item => `
          <li class="card" style="padding:14px;border-radius:12px;background:rgba(7,12,25,.6);border:1px solid rgba(255,255,255,.08)">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
              <span class="pill">Salle ${item.room}</span>
              <strong style="font-size:13px;color:var(--text)">${item.name}</strong>
            </div>
          </li>
        `),
        '</ul>'
      ].join('');
      box.innerHTML = html;
    }

    function render(){
      document.title = SETTINGS.title; document.getElementById('target-count').textContent = SETTINGS.roundsTarget;
      const total = state.seq.length; if(state.i >= total){ setProgress(total); showFinish(); return; }
      if(state.i === 0 && !state.startedAt){ state.startedAt = Date.now(); }
      const current = POOL[state.seq[state.i]]; state.stepStartedAt = Date.now(); saveState(state);

      ui.themeLabel.textContent = ''; // supprime « En quête… »
      ui.riddle.textContent = current.riddle || `Trouve la salle associée à ${current.name} puis saisis le code.`;
      ui.code.value = ''; ui.code.disabled = false; ui.btnValidate.disabled = false;

      disableHint(HINT_DELAY_MS); setupHintLock();
      ui.feedback.textContent = ''; ui.feedback.className = 'muted'; ui.nextClue.style.display = 'none';
      setProgress(state.i); ui.code.focus();
    }

    function tryValidate(){
      const total = state.seq.length; if(state.i >= total) return;
      const current = POOL[state.seq[state.i]], val = normCode(ui.code.value);
      const ok = val && val === normCode(current.code);
      if(ok){
        ui.feedback.textContent = `✅ Code valide ! (Salle ${current.room})`;
        ui.feedback.className = 'success';
        ui.feedback.style.background = 'rgba(34,197,94,.1)'; ui.feedback.style.border = '1px solid rgba(34,197,94,.3)';
        ui.nextClue.style.display = 'block';
        state.i += 1; saveState(state); setProgress(state.i);
        setTimeout(()=>{ render(); }, 800);
      } else {
        ui.feedback.textContent = '❌ Code incorrect… vérifie bien ce qui est affiché devant la salle.';
        ui.feedback.className = 'error';
        ui.feedback.style.background = 'rgba(239,68,68,.1)'; ui.feedback.style.border = '1px solid rgba(239,68,68,.3)';
      }
    }

    ui.btnValidate.addEventListener('click', tryValidate);
    ui.code.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ tryValidate(); }});
    ui.btnHint.addEventListener('click', ()=>{
      const total = state.seq.length; if(state.i >= total) return;
      if(ui.btnHint.disabled){
        ui.feedback.textContent = "⏳ Patience… l'indice sera disponible après 5 minutes.";
        ui.feedback.className = 'warn';
        ui.feedback.style.background = 'rgba(245,158,11,.1)'; ui.feedback.style.border = '1px solid rgba(245,158,11,.3)';
        return;
      }
      const current = POOL[state.seq[state.i]];
      ui.feedback.textContent = '💡 ' + (current.hint || 'Pas d\'indice pour cette énigme.');
      ui.feedback.className = 'warn';
      ui.feedback.style.background = 'rgba(245,158,11,.1)'; ui.feedback.style.border = '1px solid rgba(245,158,11,.3)';
    });

    function resetAndNewRun(){
      if(hintTimer){ clearTimeout(hintTimer); } if(hintTicker){ clearInterval(hintTicker); }
      state = createRun(); saveState(state); document.getElementById('finish-screen').style.display='none'; ui.gameGrid.style.display='grid'; render();
    }
    document.getElementById('btn-reset').addEventListener('click', ()=>{ if(confirm('Réinitialiser la progression du jeu ?')) resetAndNewRun(); });
    ui.btnReplay.addEventListener('click', ()=>{ resetAndNewRun(); });
    ui.btnReset2.addEventListener('click', ()=>{ resetAndNewRun(); });

    window.addEventListener('keydown', (e)=>{ if(e.altKey && (e.key==='n' || e.key==='N')){ state.i = clamp(state.i+1, 0, state.seq.length); saveState(state); render(); }});

    renderSidebarList(); render();
  </script>
</body>
</html>
